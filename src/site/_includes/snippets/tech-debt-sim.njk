<div class="tech-debt-sim" style="border: 1px solid #444; padding: 20px; border-radius: 8px; font-family: monospace; background: var(--background-secondary, #1e1e1e);">
    <style>
        .tech-debt-sim input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #444;
            border-radius: 4px;
            outline: none;
        }
        .tech-debt-sim input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4caf50;
            cursor: pointer;
            border: 2px solid #2e7d32;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.2);
        }
        .tech-debt-sim input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4caf50;
            cursor: pointer;
            border: 2px solid #2e7d32;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.2);
        }
        .tech-debt-sim input[type="range"]::-moz-range-track {
            height: 8px;
            background: #444;
            border-radius: 4px;
        }
    </style>
    <div style="margin-bottom: 16px;">
        <label style="display: flex; align-items: left; gap: 12px; flex-wrap: wrap;">
            <span>Refactor allocation:</span>
            <span class="sim-refactor-val" style="font-weight: bold;">30</span><span>%</span>
            <span class="sim-break-even" style="color: var(--text-muted, #888); font-weight: normal;"></span>
        </label>
        <input type="range" class="sim-refactor-slider" min="0" max="100" value="30" style="width: 100%; margin: 8px 0; display: block;">
    </div>

    <div class="sim-presets" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;">
        <button type="button" class="sim-preset" data-refactor="10" style="padding: 6px 12px; font-size: 0.8em; border-radius: 6px; border: 1px solid #555; background: #333; color: var(--text-normal, #ccc); cursor: pointer;">Startup rush</button>
        <button type="button" class="sim-preset" data-refactor="30" style="padding: 6px 12px; font-size: 0.8em; border-radius: 6px; border: 1px solid #555; background: #333; color: var(--text-normal, #ccc); cursor: pointer;">Sustainable</button>
        <button type="button" class="sim-preset" data-refactor="50" style="padding: 6px 12px; font-size: 0.8em; border-radius: 6px; border: 1px solid #555; background: #333; color: var(--text-normal, #ccc); cursor: pointer;">Enterprise safe</button>
        <button type="button" class="sim-preset" data-refactor="80" style="padding: 6px 12px; font-size: 0.8em; border-radius: 6px; border: 1px solid #555; background: #333; color: var(--text-normal, #ccc); cursor: pointer;">Full refactor</button>
    </div>

    <div class="sim-bars" style="display: flex; gap: 12px; height: 140px; align-items: flex-end;">
        <div class="sim-bar-velocity" style="width: 30%; min-height: 12px; background-color: #4caf50; border-radius: 4px 4px 0 0; text-align: center; color: white; display: flex; align-items: center; justify-content: center; font-size: 0.8em; transition: height 0.3s ease, background-color 0.3s ease;">—</div>
        <div class="sim-bar-debt" style="width: 30%; min-height: 12px; background-color: #4caf50; border-radius: 4px 4px 0 0; text-align: center; color: white; display: flex; align-items: center; justify-content: center; font-size: 0.8em; transition: height 0.3s ease, background-color 0.3s ease;">—</div>
        <div class="sim-bar-morale" style="width: 30%; min-height: 12px; background-color: #4caf50; border-radius: 4px 4px 0 0; text-align: center; color: white; display: flex; align-items: center; justify-content: center; font-size: 0.8em; transition: height 0.3s ease, background-color 0.3s ease;">—</div>
    </div>
    <div style="display: flex; gap: 12px; margin-top: 4px; font-size: 0.75em; color: var(--text-muted, #888);">
        <span style="width: 30%; text-align: center;">Velocity</span>
        <span style="width: 30%; text-align: center;">Tech debt</span>
        <span style="width: 30%; text-align: center;">Morale</span>
    </div>

    <div class="sim-meta" style="margin-top: 14px; font-size: 0.9em; color: var(--text-muted, #888);">
        <span class="sim-tick-label">Week 0</span>
    </div>
    <div class="sim-log" style="margin-top: 8px; font-size: 0.85em; color: var(--text-normal, #ccc); min-height: 1.4em;"></div>
</div>

<script>
(function() {
    'use strict';

    const DEBT_GROWTH_PER_TICK = 1.5;
    const DEBT_PAYBACK_PER_TICK = 3.5;
    const TICK_MS = 1200;
    const MIN_BAR_PCT = 12;
    const CAP = 100;

    /**
     * @typedef {{ debt: number, velocity: number, morale: number, tick: number }} SimState
     */

    function clamp(value) {
        return Math.max(0, Math.min(CAP, value));
    }

    /**
     * Pure: compute next simulation state.
     */
    function nextState(current, refactorRate) {
        const r = refactorRate / 100;
        
        // Compound Interest
        const complexityFactor = 1 + (current.debt / 50); 
        const growth = (1 - r) * DEBT_GROWTH_PER_TICK * complexityFactor;
        const payback = r * DEBT_PAYBACK_PER_TICK;
        const debtDelta = growth - payback;
        const newDebt = clamp(current.debt + debtDelta);

        // Strict Realism: Debt kills velocity 1-to-1
        const debtDrag = newDebt * 1.0;
        const refactorTax = refactorRate * 1.0;
        const newVelocity = clamp(100 - debtDrag - refactorTax);
        
        // Morale penalty
        const newMorale = clamp(100 - newDebt * 0.4 - (100 - newVelocity) * 0.5);

        return {
            debt: newDebt,
            velocity: newVelocity,
            morale: newMorale,
            tick: current.tick + 1
        };
    }

    /**
     * Pure: Break-even refactor % for current debt (Growth = Payback).
     */
    function getBreakEvenPct(state) {
        const complexityFactor = 1 + (state.debt / 50);
        const breakEvenRate = (1.5 * complexityFactor) / (3.5 + 1.5 * complexityFactor);
        return Math.round(breakEvenRate * 100);
    }

    /**
     * Pure: Snapshot-based messaging.
     */
    function getLogMessage(state) {
        const baseMsg = (() => {
            // 1. GAME OVER
            if (state.debt >= 90) {
                return 'GAME OVER: The system is paralyzed. You must switch to "Full Refactor" immediately.';
            }

            // 2. DANGER ZONE (High Debt)
            if (state.debt >= 50) {
                return 'WARNING: High technical debt is compounding. Velocity is suffering.';
            }

            // 3. SUSTAINABLE ZONE (Clean code)
            if (state.debt < 25) {
                if (state.velocity < 50) {
                    return 'Inefficient: Code is clean, but you are refactoring too much ("Gold Plating"). Ship more features.';
                }
                if (state.velocity > 85) {
                    return 'Sugar Rush: You are moving recklessly fast. Debt will spike soon.';
                }
                return 'Healthy: The team is maintaining a sustainable, professional pace.';
            }

            // 4. MIDDLE GROUND (25-50 Debt)
            return 'Project Running: Watch the debt levels; do not let them cross 50%.';
        })();

        return baseMsg;
    }

    /**
     * Side-effect only: update DOM.
     */
    function render(state, refactorRate, container) {
        const refactorVal = container.querySelector('.sim-refactor-val');
        const breakEvenEl = container.querySelector('.sim-break-even');
        const barVelocity = container.querySelector('.sim-bar-velocity');
        const barDebt = container.querySelector('.sim-bar-debt');
        const barMorale = container.querySelector('.sim-bar-morale');
        const tickLabel = container.querySelector('.sim-tick-label');
        const log = container.querySelector('.sim-log');

        if (refactorVal) refactorVal.textContent = String(refactorRate);

        if (breakEvenEl) {
            const breakEvenPct = getBreakEvenPct(state);
            if (breakEvenPct === refactorRate) {
                breakEvenEl.textContent = '';
                breakEvenEl.style.display = 'none';
            } else {
                breakEvenEl.textContent = ' (Break-even: ' + breakEvenPct + '%)';
                breakEvenEl.style.display = '';
            }
        }

        // --- VELOCITY BAR ---
        if (barVelocity) {
            barVelocity.style.height = Math.max(MIN_BAR_PCT, state.velocity) + '%';
            barVelocity.textContent = String(Math.round(state.velocity));

            if (state.velocity > 85) {
                // Reckless Orange
                barVelocity.style.backgroundColor = '#ff9800'; 
                barVelocity.style.color = 'white';
            } else if (state.velocity >= 65) {
                // Healthy Green
                barVelocity.style.backgroundColor = '#4caf50'; 
                barVelocity.style.color = 'white';
            } else if (state.velocity >= 40) {
                // Struggling Yellow
                barVelocity.style.backgroundColor = '#ffeb3b'; 
                barVelocity.style.color = '#333';
            } else {
                // Stalled Red
                barVelocity.style.backgroundColor = '#f44336'; 
                barVelocity.style.color = 'white';
            }
        }

        // --- DEBT BAR ---
        if (barDebt) {
            barDebt.style.height = Math.max(MIN_BAR_PCT, state.debt) + '%';
            barDebt.textContent = String(Math.round(state.debt));

            if (state.debt < 25) {
                // Low Debt (Healthy) -> Green
                barDebt.style.backgroundColor = '#4caf50';
                barDebt.style.color = 'white';
            } else if (state.debt < 50) {
                // Medium Debt (Warning) -> Yellow
                barDebt.style.backgroundColor = '#ffeb3b';
                barDebt.style.color = '#333';
            } else {
                // High Debt (Critical) -> Red
                barDebt.style.backgroundColor = '#f44336';
                barDebt.style.color = 'white';
            }
        }

        // --- MORALE BAR ---
        if (barMorale) {
            barMorale.style.height = Math.max(MIN_BAR_PCT, state.morale) + '%';
            barMorale.textContent = String(Math.round(state.morale));
            
            if (state.morale >= 80) {
                 // High Morale (Happy) -> Green
                barMorale.style.backgroundColor = '#4caf50';
                barMorale.style.color = 'white';
            } else if (state.morale >= 50) {
                 // Med Morale (Anxious) -> Yellow
                barMorale.style.backgroundColor = '#ffeb3b';
                barMorale.style.color = '#333';
            } else {
                 // Low Morale (Burnout) -> Red
                barMorale.style.backgroundColor = '#f44336';
                barMorale.style.color = 'white';
            }
        }

        if (tickLabel) tickLabel.textContent = 'Week ' + state.tick;
        if (log) log.textContent = getLogMessage(state);
    }

    const containers = document.querySelectorAll('.tech-debt-sim');
    containers.forEach(function(container) {
        /** @type {SimState} */
        let state = { debt: 0, velocity: 70, morale: 85, tick: 0 };
        /** @type {number} */
        let refactorRate = 30;
        /** @type {ReturnType<typeof setInterval> | null} */
        let tickTimer = null;

        function tick() {
            state = nextState(state, refactorRate);
            render(state, refactorRate, container);
        }

        function startLoop() {
            if (tickTimer !== null) return;
            tickTimer = setInterval(tick, TICK_MS);
        }

        function stopLoop() {
            if (tickTimer !== null) {
                clearInterval(tickTimer);
                tickTimer = null;
            }
        }

        function applyRefactorRate(value) {
            refactorRate = Math.max(0, Math.min(100, value));
            const slider = container.querySelector('.sim-refactor-slider');
            if (slider instanceof HTMLInputElement) {
                slider.value = String(refactorRate);
            }
            render(state, refactorRate, container);
        }

        function init() {
            const slider = container.querySelector('.sim-refactor-slider');
            if (slider instanceof HTMLInputElement) {
                slider.value = String(refactorRate);
                slider.addEventListener('input', function() {
                    const parsed = Number.parseInt(slider.value, 10);
                    refactorRate = Number.isNaN(parsed) ? refactorRate : parsed;
                    render(state, refactorRate, container);
                });
            }

            container.querySelectorAll('.sim-preset').forEach(function(btn) {
                const val = btn.getAttribute('data-refactor');
                if (val !== null) {
                    const pct = Number.parseInt(val, 10);
                    if (!Number.isNaN(pct)) {
                        btn.addEventListener('click', function() {
                            applyRefactorRate(pct);
                        });
                    }
                }
            });

            render(state, refactorRate, container);

            if (document.visibilityState === 'visible') {
                startLoop();
            }
            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'hidden') {
                    stopLoop();
                } else {
                    startLoop();
                }
            });
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    });
})();
</script>
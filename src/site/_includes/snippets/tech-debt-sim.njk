<div class="tech-debt-sim" style="border: 1px solid #444; padding: 20px; border-radius: 8px; font-family: monospace; background: var(--background-secondary, #1e1e1e);">
    <style>
        .tech-debt-sim input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #444;
            border-radius: 4px;
            outline: none;
        }
        .tech-debt-sim input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4caf50;
            cursor: pointer;
            border: 2px solid #2e7d32;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.2);
        }
        .tech-debt-sim input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4caf50;
            cursor: pointer;
            border: 2px solid #2e7d32;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.2);
        }
        .tech-debt-sim input[type="range"]::-moz-range-track {
            height: 8px;
            background: #444;
            border-radius: 4px;
        }
    </style>
    <div style="margin-bottom: 16px;">
        <label style="display: flex; align-items: left; gap: 12px;">
            <span>Refactor allocation:</span>
            <span class="sim-refactor-val" style="font-weight: bold;">30</span><span>%</span>
        </label>
        <input type="range" class="sim-refactor-slider" min="0" max="100" value="30" style="width: 100%; margin: 8px 0; display: block;">
    </div>

    <div class="sim-presets" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;">
        <button type="button" class="sim-preset" data-refactor="10" style="padding: 6px 12px; font-size: 0.8em; border-radius: 6px; border: 1px solid #555; background: #333; color: var(--text-normal, #ccc); cursor: pointer;">Startup rush</button>
        <button type="button" class="sim-preset" data-refactor="30" style="padding: 6px 12px; font-size: 0.8em; border-radius: 6px; border: 1px solid #555; background: #333; color: var(--text-normal, #ccc); cursor: pointer;">Sustainable</button>
        <button type="button" class="sim-preset" data-refactor="50" style="padding: 6px 12px; font-size: 0.8em; border-radius: 6px; border: 1px solid #555; background: #333; color: var(--text-normal, #ccc); cursor: pointer;">Enterprise safe</button>
        <button type="button" class="sim-preset" data-refactor="80" style="padding: 6px 12px; font-size: 0.8em; border-radius: 6px; border: 1px solid #555; background: #333; color: var(--text-normal, #ccc); cursor: pointer;">Full refactor</button>
    </div>

    <div class="sim-bars" style="display: flex; gap: 12px; height: 140px; align-items: flex-end;">
        <div class="sim-bar-velocity" style="width: 30%; min-height: 12px; background: #4caf50; border-radius: 4px 4px 0 0; text-align: center; color: white; display: flex; align-items: center; justify-content: center; font-size: 0.8em; transition: height 0.3s ease;">—</div>
        <div class="sim-bar-debt" style="width: 30%; min-height: 12px; background: #f44336; border-radius: 4px 4px 0 0; text-align: center; color: white; display: flex; align-items: center; justify-content: center; font-size: 0.8em; transition: height 0.3s ease;">—</div>
        <div class="sim-bar-morale" style="width: 30%; min-height: 12px; background: #2196f3; border-radius: 4px 4px 0 0; text-align: center; color: white; display: flex; align-items: center; justify-content: center; font-size: 0.8em; transition: height 0.3s ease;">—</div>
    </div>
    <div style="display: flex; gap: 12px; margin-top: 4px; font-size: 0.75em; color: var(--text-muted, #888);">
        <span style="width: 30%; text-align: center;">Velocity</span>
        <span style="width: 30%; text-align: center;">Tech debt</span>
        <span style="width: 30%; text-align: center;">Morale</span>
    </div>

    <div class="sim-meta" style="margin-top: 14px; font-size: 0.9em; color: var(--text-muted, #888);">
        <span class="sim-tick-label">Week 0</span>
    </div>
    <div class="sim-log" style="margin-top: 8px; font-size: 0.85em; color: var(--text-normal, #ccc); min-height: 1.4em;"></div>
</div>

<script>
(function() {
    'use strict';

    const DEBT_GROWTH_PER_TICK = 1.5;
    const DEBT_PAYBACK_PER_TICK = 3.5;
    const TICK_MS = 1200;
    const MIN_BAR_PCT = 12;
    const CAP = 100;

    /**
     * @typedef {{ debt: number, velocity: number, morale: number, tick: number }} SimState
     */

    /**
     * Clamp a value to [0, CAP].
     * @param {number} value
     * @returns {number}
     */
    function clamp(value) {
        return Math.max(0, Math.min(CAP, value));
    }

    /**
     * Pure: compute next simulation state from current state and refactor rate.
     * @param {SimState} current
     * @param {number} refactorRate - 0..100
     * @returns {SimState}
     */
    function nextState(current, refactorRate) {
        const r = refactorRate / 100;
        const complexityFactor = 1 + (current.debt / 50); 
        const growth = (1 - r) * DEBT_GROWTH_PER_TICK * complexityFactor;        const payback = r * DEBT_PAYBACK_PER_TICK;
        const debtDelta = growth - payback;
        const newDebt = clamp(current.debt + debtDelta);

        const debtDrag = newDebt * 1.0;
        const refactorTax = refactorRate * 1.0;
        const newVelocity = clamp(100 - debtDrag - refactorTax);
        const newMorale = clamp(100 - newDebt * 0.4 - (100 - newVelocity) * 0.5);

        return {
            debt: newDebt,
            velocity: newVelocity,
            morale: newMorale,
            tick: current.tick + 1
        };
    }

/**
     * Pure: derive log message from state and refactor rate.
     * @param {SimState} state
     * @param {number} refactorRate
     * @returns {string}
     */
     function getLogMessage(state, refactorRate) {
        // 1. Calculate the trend
        const r = refactorRate / 100;
        const complexityFactor = 1 + (state.debt / 50); 
        const growth = (1 - r) * 1.5 * complexityFactor;
        const payback = r * 3.5;
        const netChange = growth - payback;

        // 2. Calculate the exact "Break Even" point for this debt level
        // Math: Growth = Payback  ->  (1-r)*1.5*C = r*3.5  ->  r = (1.5*C) / (3.5 + 1.5*C)
        const breakEvenRate = (1.5 * complexityFactor) / (3.5 + 1.5 * complexityFactor);
        const breakEvenPct = Math.round(breakEvenRate * 100);

        // --- SCENARIO 0: TOTAL COLLAPSE (GAME OVER) ---
        if (state.debt >= 95) {
             if (netChange < -1) return 'System Reset: You are effectively rewriting the app. Keep going, but expect zero features for weeks.';
             return 'GAME OVER: The team is paralyzed. You cannot ship. You must switch to 100% refactoring to survive.';
        }

        // --- SCENARIO 1: CRITICAL DEBT (80-95) ---
        if (state.debt >= 80) {
            if (netChange < -0.5) return 'CRITICAL: Good. You are paying down the debt, but it will take time to recover velocity.';
            if (netChange < 0) return 'CRITICAL: Debt is slowly decreasing. Push harder (increase refactor) to escape the death spiral.';
            return 'CRITICAL: The system is collapsing. You are still accumulating debt. STOP SHIPPING FEATURES immediately.';
        }

        // --- SCENARIO 2: HIGH DEBT (50-80) ---
        if (state.debt >= 50) {
            if (netChange < 0) return 'Recovering: Debt is high, but the trend is positive. Morale will improve soon.';
            // USE THE CALCULATED VALUE HERE
            return 'WARNING: High debt is compounding. You need at least ' + breakEvenPct + '% allocation just to stop it from growing.';
        }

        // --- SCENARIO 3: MODERATE DEBT (25-50) ---
        if (state.debt >= 25) {
            if (netChange > 0.1) return 'Caution: Debt is creeping up. Don\'t let it compound.';
            // Only say "Grinding" if they are actually trying to fix it (netChange <= 0)
            if (state.velocity < 50 && netChange <= 0) return 'Grinding: The debt drag is heavy, but you are doing the right thing. Hold the line.';
            if (state.velocity < 50) return 'Stuck: Velocity is low because of debt. You are not refactoring enough to fix it.';
        }

        // --- SCENARIO 4: LOW DEBT (<25) ---
        if (state.debt < 25) {
            if (refactorRate > 60) return 'Gold Plating: The code is pristine. You can likely afford to ship more features (lower the slider).';
            if (netChange > 0.5) return 'Sugar Rush: You are shipping fast, but debt is piling up quickly. Watch out!';
            if (state.velocity > 70) return 'Sustainable: The team is in the zone. Great balance.';
        }

        // Fallback
        if (netChange > 0) return 'Drifting: Debt is slowly accumulating. Keep an eye on it.';
        return 'Stable: The codebase is healthy.';
    }

    /**
     * Side-effect only: update DOM from state and refactor rate.
     * @param {SimState} state
     * @param {number} refactorRate
     * @param {Element} container
     */
    function render(state, refactorRate, container) {
        const refactorVal = container.querySelector('.sim-refactor-val');
        const barVelocity = container.querySelector('.sim-bar-velocity');
        const barDebt = container.querySelector('.sim-bar-debt');
        const barMorale = container.querySelector('.sim-bar-morale');
        const tickLabel = container.querySelector('.sim-tick-label');
        const log = container.querySelector('.sim-log');

        if (refactorVal) refactorVal.textContent = String(refactorRate);
        if (barVelocity) {
            barVelocity.style.height = Math.max(MIN_BAR_PCT, state.velocity) + '%';
            barVelocity.textContent = String(Math.round(state.velocity));
        }
        if (barDebt) {
            barDebt.style.height = Math.max(MIN_BAR_PCT, state.debt) + '%';
            barDebt.textContent = String(Math.round(state.debt));
        }
        if (barMorale) {
            barMorale.style.height = Math.max(MIN_BAR_PCT, state.morale) + '%';
            barMorale.textContent = String(Math.round(state.morale));
        }
        if (tickLabel) tickLabel.textContent = 'Week ' + state.tick;
        if (log) log.textContent = getLogMessage(state, refactorRate);
    }

    const containers = document.querySelectorAll('.tech-debt-sim');
    containers.forEach(function(container) {
        /** @type {SimState} */
        let state = { debt: 0, velocity: 70, morale: 85, tick: 0 };
        /** @type {number} */
        let refactorRate = 30;
        /** @type {ReturnType<typeof setInterval> | null} */
        let tickTimer = null;

        function tick() {
            state = nextState(state, refactorRate);
            render(state, refactorRate, container);
        }

        function startLoop() {
            if (tickTimer !== null) return;
            tickTimer = setInterval(tick, TICK_MS);
        }

        function stopLoop() {
            if (tickTimer !== null) {
                clearInterval(tickTimer);
                tickTimer = null;
            }
        }

        function applyRefactorRate(value) {
            refactorRate = Math.max(0, Math.min(100, value));
            const slider = container.querySelector('.sim-refactor-slider');
            if (slider instanceof HTMLInputElement) {
                slider.value = String(refactorRate);
            }
            render(state, refactorRate, container);
        }

        function init() {
            const slider = container.querySelector('.sim-refactor-slider');
            if (slider instanceof HTMLInputElement) {
                slider.value = String(refactorRate);
                slider.addEventListener('input', function() {
                    const parsed = Number.parseInt(slider.value, 10);
                    refactorRate = Number.isNaN(parsed) ? refactorRate : parsed;
                    render(state, refactorRate, container);
                });
            }
            container.querySelectorAll('.sim-preset').forEach(function(btn) {
                const val = btn.getAttribute('data-refactor');
                if (val !== null) {
                    const pct = Number.parseInt(val, 10);
                    if (!Number.isNaN(pct)) {
                        btn.addEventListener('click', function() {
                            applyRefactorRate(pct);
                        });
                    }
                }
            });
            render(state, refactorRate, container);
            if (document.visibilityState === 'visible') {
                startLoop();
            }
            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'hidden') {
                    stopLoop();
                } else {
                    startLoop();
                }
            });
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    });
})();
</script>
